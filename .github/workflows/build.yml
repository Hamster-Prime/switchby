name: Build Switch NRO

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkita64:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Switch libraries
        run: |
          sudo dkp-pacman -Syu --noconfirm
          sudo dkp-pacman -S --noconfirm \
            switch-dev \
            switch-portlibs \
            switch-curl \
            switch-mbedtls \
            switch-zlib \
            switch-bzip2 \
            switch-freetype \
            switch-libpng \
            switch-libjpeg-turbo \
            switch-sdl2 \
            switch-sdl2_image \
            switch-sdl2_ttf \
            switch-mesa \
            switch-glad \
            switch-glfw \
            switch-libdrm_nouveau \
            dkp-cmake-common-utils

      - name: Install mpv for Switch
        run: |
          # Clone and build switch-mpv if not available via pacman
          git clone --depth 1 https://github.com/xfangfang/wiliwili.git /tmp/wiliwili || true
          # Use prebuilt libs from wiliwili if available
          echo "MPV will be handled by the build system"

      - name: Configure CMake
        run: |
          source $DEVKITPRO/switchvars.sh
          cmake -B build -G "Unix Makefiles" \
                -DPLATFORM=SWITCH \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_TOOLCHAIN_FILE=${DEVKITPRO}/cmake/Switch.cmake

      - name: Build project
        run: |
          source $DEVKITPRO/switchvars.sh
          cmake --build build -j$(nproc)

      - name: Prepare artifact
        run: |
          mkdir -p artifacts
          cp build/switchby.nro artifacts/ 2>/dev/null || true
          cp build/*.nro artifacts/ 2>/dev/null || true
          ls -la artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: switchby-nro
          path: artifacts/
          if-no-files-found: warn
